<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <!--[if lte IE 9]><meta http-equiv="refresh" content="0;url=/ie.html"><![endif]-->

    <title>Android 4.2源代码编译教程</title>
    <meta name="description" content="">

    <link rel="stylesheet" type="text/css" href="/assets/css/style.css">
<script type="text/javascript">
            function  Trim(strValue)     
            {     
                    return   strValue.replace(/^s*|s*$/g,"");     
            }
                 
            function SetCookie(sName,sValue)     
            {     
                   document.cookie = sName + "=" + escape(sValue);     
           }   
           
           function GetCookie(sName)     
           {     
                 var aCookie = document.cookie.split(";");     
               for(var　i=0;　i　< aCookie.length;　i++)     
               {     
                     var aCrumb = aCookie[i].split("=");     
                   if(sName　== Trim(aCrumb[0]))     
                   {     
                       return unescape(aCrumb[1]);     
                   }     
                  }     
     
               　　return null;     
             } 
                 
           function scrollback()     
           {     
                 if(GetCookie("scroll")!=null){document.body.scrollTop=GetCookie("scroll")}     
           }     
     </script>
 </head>
  <body id=body  onscroll=SetCookie("scroll",body.scrollTop);onload="scrollback();">
    <aside id="sidebar">
      <nav id="tags">
        <a href="/index.html" id="avatar"></a>

        <ul id="tags__ul" >
          <li id="js-label1" class="tags__li tags-btn active">以前的All Posts</li>
          <li id="js-label2" class="tags__li tags-btn">嵌入式Embedded</li>
          <li id="js-label3" class="tags__li tags-btn">算法Algorithm</li>
          <li id="js-label4" class="tags__li tags-btn">Linux</li>
          <li id="js-label5" class="tags__li tags-btn">网络Network</li>
          <li id="js-label6" class="tags__li tags-btn">Android</li>
          <!--<li id="js-label7" class="tags__li tags-btn">RTOS</li>-->
          <li id="js-label8" class="tags__li tags-btn">生活My Life</li>
          <li id="js-label9" class="tags__li tags-btn">其他Other</li>
        </ul>

        <div id="tags__bottom">
          <a href="mailto:huangxu@hust.edu.cn" id="icon-email" class="tags-btn fontello"></a>
          <!--<a href="/rss.xml" id="icon-feed" class="tags-btn fontello"></a>-->
        </div>
      </nav> <!-- end #tags -->

      <div id="posts-list">
        <form action="" id="search-form">
          <a href="/index.html" id="mobile-avatar"></a>
          <!-- NOTE: input field is disabled by default 
          <input id="search-input" type="text" placeholder="Search..." disabled >-->
        </form>

        <nav id="pl__container">
		 
		 <!--<a class="pl__time_total">
		 <strong >Apr 2016</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="life pl__all" href="/life/2016/04/05/C++%E5%AD%A6%E4%B9%A0%E4%B9%A6%E7%B1%8D.html"><span class="pl__circle"></span><span class="pl__title">C++学习书籍</span><strong class="pl__date">life</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Apr 2016</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="life pl__all" href="/life/2016/04/05/Effective-C++-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html"><span class="pl__circle"></span><span class="pl__title">《Effective C++》-读书笔记</span><strong class="pl__date">life</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Jan 2016</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="Life pl__all" href="/life/2016/01/26/%E5%A4%A7%E8%AF%9D%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0.html"><span class="pl__circle"></span><span class="pl__title">《大话设计模式》-读书笔记</span><strong class="pl__date">Life</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Oct 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="Android pl__all" href="/android/2015/10/22/Android-ROM%E7%AE%80%E5%8D%95%E5%AE%9A%E5%88%B6.html"><span class="pl__circle"></span><span class="pl__title">（未完成）简单定制Android ROM</span><strong class="pl__date">Android</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Oct 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="android pl__all" href="/android/2015/10/21/Android4.2%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91.html"><span class="pl__circle"></span><span class="pl__title">Android 4.2源代码编译教程</span><strong class="pl__date">android</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Oct 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="linux pl__all" href="/linux/2015/10/21/grep%E4%B8%8Efind%E5%AE%9E%E7%8E%B0%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6%E5%86%85%E5%AE%B9%E6%9F%A5%E6%89%BE.html"><span class="pl__circle"></span><span class="pl__title">grep与find多文件内容查找</span><strong class="pl__date">linux</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Jan 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="network pl__all" href="/network/2015/01/31/Linux%E4%B8%8BSocket%E9%80%9A%E4%BF%A1%E6%B1%87%E6%80%BB.html"><span class="pl__circle"></span><span class="pl__title">Linux下Socket编程备忘</span><strong class="pl__date">network</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Jan 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="linux pl__all" href="/linux/2015/01/26/Makefile%E5%9F%BA%E7%A1%80%E6%95%99%E7%A8%8B.html"><span class="pl__circle"></span><span class="pl__title">多级目录Makefile编写方法</span><strong class="pl__date">linux</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Jan 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="other pl__all" href="/other/2015/01/18/Git%E5%91%BD%E4%BB%A4%E7%AC%94%E8%AE%B0.html"><span class="pl__circle"></span><span class="pl__title">#Git命令笔记</span><strong class="pl__date">other</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Jan 2015</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="linux pl__all" href="/linux/2015/01/10/C%E4%B8%8Eshell%E7%9A%84%E7%9B%B8%E4%BA%92%E8%B0%83%E7%94%A8.html"><span class="pl__circle"></span><span class="pl__title">C与shell的相互调用</span><strong class="pl__date">linux</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Dec 2014</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="linux pl__all" href="/linux/2014/12/17/vim-%E7%BC%96%E8%BE%91%E5%99%A8%E4%B9%8B%E7%A5%9E.html"><span class="pl__circle"></span><span class="pl__title">VIM 编辑器之神</span><strong class="pl__date">linux</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Dec 2014</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="linux pl__all" href="/linux/2014/12/17/shell-%E5%8F%98%E9%87%8F%E5%B1%9E%E6%80%A7.html"><span class="pl__circle"></span><span class="pl__title">shell中变量的访问权限控制</span><strong class="pl__date">linux</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Dec 2014</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="other pl__all" href="/other/2014/12/15/recommend-some-useful-website.html"><span class="pl__circle"></span><span class="pl__title">推荐一些网站</span><strong class="pl__date">other</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Dec 2014</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="life pl__all" href="/life/2014/12/15/the-interview-experience-of-Tencent.html"><span class="pl__circle"></span><span class="pl__title">The Interview Experience of Tencent</span><strong class="pl__date">life</strong></a>
		
		 <!--<a class="pl__time_total">
		 <strong >Dec 2014</strong>
		 <strong >temp</strong>-->
		 </a>
          <a class="life pl__all" href="/life/2014/12/14/what's-CVTE.html"><span class="pl__circle"></span><span class="pl__title">What's CVTE</span><strong class="pl__date">life</strong></a>
		
        </nav>
      </div> <!-- end #posts-list -->
    </aside> <!-- end #sidebar -->

    <div id="post">
      <div id="pjax">
        <article id="post__content">
  <h1 id="post__title" data-identifier="20151021">Android 4.2源代码编译教程</h1>
  <h2 id="section">背景</h2>

<p>Android源代码作为公开源码,不读一下,总感觉Android学的不够(其实本来就不够),心里不踏实.这里就Nexus 7为基础,对Android 4.2源代码进行了编译,希望自己能够装X成功!</p>

<h2 id="section-1">编译环境搭建</h2>

<h3 id="section-2">基础环境</h3>

<blockquote>
  <ul>
    <li>操作系统:Ubuntu 14.04-64位(虚拟机)</li>
    <li>运行硬件:nexus 7 I代(WIFI)</li>
    <li>硬盘:60G</li>
    <li>内存:1G</li>
    <li>虚拟内存:2G</li>
    <li>翻墙软件:<a href="http://www.yueliang123.com/">月亮VPN:￥15/月</a>   <a href="http://www.vpn333.cn">VPN333:￥18/月</a></li>
    <li>JDK:JAVA SE 6 <a href="http://www.oracle.com/technetwork/java/javase/archive-139210.html">下载</a></li>
    <li>SDK:23 <a href="http://developer.android.com/sdk/installing/adding-packages.html">下载</a></li>
  </ul>
</blockquote>

<h3 id="section-3">编译所需工具链</h3>

<p>在Ubuntu 联网的情况下,通过下面命令安装所需的包:</p>

<p><code class="highlighter-rouge">sudo apt-get install gcc-multilib bison g++-multilib git gperf libxml2-utils make libncurses5-dev lib32ncurses5-dev libswitch-perl libgl1-mesa-glx:i386 libglapi-mesa:i386 libgl1-mesa-dev:i386 python-networkx zlib1g-dev:i386 zip schedtool xsltproc flex</code></p>

<p>因为Android SDK没有64位版本,64位的操作系统需安装如下支持包:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">libc6</span><span class="o">-</span><span class="n">i386</span> <span class="n">lib32stdc</span><span class="o">++</span><span class="mi">6</span> <span class="n">lib32gcc1</span> <span class="n">lib32ncurses5</span> <span class="n">lib32z1</span></code></pre></figure>

<p>通过<sdk目录>/tool/android 启动sdk-tool,后借助翻墙软件,可下载相应的工具,如adb,fastboot等.</sdk目录></p>

<p>下载完,需要将JDK,SDK等软件添加到/etc/profile 中,以便添加到环境变量中.</p>

<h2 id="section-4">源码下载</h2>

<h3 id="system">System层代码</h3>

<p>Android 源代码除了谷歌官方提供的之外,还有一个重要的组织：CM，常年提供各种适配机型的源代码．这里就是使用CM的源代码.通过如下命令:
//这里假设准备把源代码下载到:/home/xbb/android/</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">mkdir</span> <span class="o">-</span><span class="nb">p</span> <span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span>
<span class="n">curl</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">repo</span><span class="p">.</span><span class="nf">googlecode</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="n">files</span><span class="o">/</span><span class="n">repo</span><span class="o">-</span><span class="mi">1</span><span class="o">.</span><span class="mi">12</span> <span class="o">&gt;</span> <span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/bin/</span><span class="n">repo</span>
<span class="n">export</span> <span class="no">PATH</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="no">PATH</span><span class="p">}</span><span class="ss">:&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/bin/</span><span class="n">repo</span>
<span class="n">repo</span> <span class="o">-</span><span class="n">init</span> <span class="o">-</span><span class="n">u</span> <span class="n">git</span><span class="ss">:/</span><span class="o">/</span><span class="n">github</span><span class="p">.</span><span class="nf">com</span><span class="o">/</span><span class="no">CyanogenMod</span><span class="o">/</span><span class="n">android</span><span class="p">.</span><span class="nf">git</span> <span class="o">-</span><span class="n">b</span> <span class="n">cm</span><span class="o">-</span><span class="mi">10</span><span class="o">.</span><span class="mi">1</span>
<span class="n">repo</span> <span class="n">sync</span></code></pre></figure>

<p>同步完成,即完成了system层代码的下载.</p>

<h3 id="hal">HAL层源代码</h3>

<p>命令:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/ventor/</span><span class="n">cm</span><span class="o">/</span><span class="n">get</span><span class="o">-</span><span class="n">prebuilts</span>
<span class="n">source</span> <span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/build/en</span><span class="n">vsetup</span><span class="o">/</span><span class="p">.</span><span class="nf">sh</span>
<span class="n">breakfast</span> <span class="n">crepo</span></code></pre></figure>

<h3 id="linux">Linux内核源代码</h3>

<p>上述同步即会下载内核代码,不过速度较慢,如果/device/中的内容下载玩,可以停止同步,手动下载相应的内核代码.
内核代码可以在CM官网,wiki中选择自己的<a href="https://wiki.cyanogenmod.org/w/Devices">Devices</a> 来选择内核下载
Nexus 7 的内核下载地址为:<a href="https://wiki.cyanogenmod.org/w/Grouper_Info">下载</a></p>

<p>下载完成后,解压到:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/kernel/</span><span class="n">asus</span><span class="o">/</span><span class="n">grouper</span><span class="o">/</span> </code></pre></figure>

<p>如果不想解压,也可自己到相应的目录,使用git对相应的代码进行clone.</p>

<p>下载完代码,发现<源代码目录>/.repo中有大量缓冲文件,文件可删除,但是后续就不方便切换分支了.
代码总大小:约27G。</源代码目录></p>

<h2 id="section-5">源码编译</h2>
<p>你好</p>

<h3 id="section-6">编译准备</h3>

<p>编译前需要从目标设备上下载相应的配置文件.需要adb支持和硬件支持.命令:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/device/</span><span class="n">asus</span><span class="o">/</span><span class="n">grouper</span><span class="o">/</span><span class="n">extract</span><span class="o">-</span><span class="n">files</span><span class="p">.</span><span class="nf">sh</span></code></pre></figure>

<p>下载完即可编译:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">export</span> <span class="no">USE_CCACHE</span><span class="o">=</span><span class="mi">1</span>
<span class="n">croot</span>
<span class="n">brunch</span> <span class="n">grouper</span></code></pre></figure>

<p>编译成功后,可得到:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/out/</span><span class="n">target</span><span class="o">/</span><span class="n">product</span><span class="o">/</span><span class="no">XXXX</span><span class="p">.</span><span class="nf">zip</span> <span class="sr">//</span><span class="err">烧录文件</span>
<span class="o">&lt;</span><span class="err">源代码目录</span><span class="o">&gt;</span><span class="sr">/out/</span><span class="n">target</span><span class="o">/</span><span class="n">product</span><span class="o">/</span><span class="n">recovery</span><span class="p">.</span><span class="nf">img</span> <span class="sr">//</span><span class="n">recovery</span> <span class="err">文件</span></code></pre></figure>

<h3 id="section-7">其他</h3>

<p>编译时长:约10小时
编译后总大小:45G</p>

<h2 id="section-8">系统烧录</h2>

<h3 id="section-9">解锁</h3>

<p>Nexus 7默认的bootloader是锁定的,需要解锁后才能进行正常的烧录,在正常开机状态下通过命令:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">adb</span> <span class="n">reboot</span> <span class="n">bootloder</span> <span class="sr">//</span><span class="err">系统进入</span><span class="n">bootloader</span><span class="err">模式</span></code></pre></figure>

<p>也可在关机状态下,同时按下”开机键、音量+、音量-“,开机后即进入bootloader模式.
通过命令:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fastboot</span> <span class="n">oem</span> <span class="n">unlock</span> <span class="sr">//</span><span class="err">解锁硬件</span></code></pre></figure>

<p>期间可能会弹出删除数据的提示,点”是”继续.当显示 lock status=unlock 即为解锁成功!</p>

<h3 id="recovery">刷入recovery</h3>

<p>通过命令输入recovery:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">fastboot</span> <span class="n">flash</span> <span class="n">recovery</span> <span class="n">recovery</span><span class="p">.</span><span class="nf">img</span> <span class="sr">//</span><span class="err">刷入</span><span class="n">recovery</span></code></pre></figure>

<p>刷入过程很快,刷完即可进入recovery模式.</p>

<h3 id="section-10">刷入系统</h3>

<p>开机重启,进入系统,因为unlock删除了数据,所以进入系统后,会有系统欢迎页面.完成后将编译好的XXXX.zip复制到手机里面.关机,开机时,同时按下”开机键、音量+、音量-“,进入recovery模式.
在recovery菜单中依次选择:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">wipe</span> <span class="n">data</span><span class="o">/</span><span class="n">factory</span> <span class="n">reset</span> <span class="o">-&gt;</span> <span class="no">YES</span>
<span class="n">wipe</span> <span class="n">cache</span> <span class="n">partition</span> <span class="o">-&gt;</span> <span class="no">YES</span>
<span class="n">install</span> <span class="n">zip</span> <span class="o">-&gt;</span> <span class="n">choose</span> <span class="n">zip</span> <span class="n">from</span> <span class="n">sdcard</span> <span class="o">-&gt;</span> <span class="no">XXXX</span><span class="p">.</span><span class="nf">zip</span><span class="err">路径</span></code></pre></figure>

<p>刷入系统完成即可重启,体验自己亲手制作的智能操作系统~</p>


</article> <!-- end #post__content -->

<!--<div id="post__share">
  <a id="icon-weibo" class="fontello" href="http://v.t.sina.com.cn/share/share.php?url=xnzaa.github.io/android/2015/10/21/Android4.2%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91.html&title=Android 4.2源代码编译教程" target="_blank"></a>
  <a id="icon-twitter" class="fontello" href="https://twitter.com/intent/tweet?url=xnzaa.github.io/android/2015/10/21/Android4.2%E6%BA%90%E4%BB%A3%E7%A0%81%E7%BC%96%E8%AF%91.html&text=Android 4.2源代码编译教程" target="_blank"></a>
  <!--<a id="icon-cc" class="fontello" href="http://creativecommons.org/licenses/by-nc-sa/3.0" target="_blank"></a>-->
<!--</div> <!-- end #post__share -->


 <script  type="text/javascript" src="http://v2.uyan.cc/code/uyan.js?uid=1995082"></script>
 
 <div id="uyan_frame"></div>
      </div> <!-- end #pjax -->

      <div id="post__toc-trigger">
        <div id="post__toc">
          <span id="post__toc-title">Table of Contents</span>
          <ul id="post__toc-ul"></ul>
        </div>
      </div>
	 <div style="text-align:center;"><a href="#" onclick="window.location.reload()" vertical-align:middle; >-----------请您赐教！-----------</a></div>
	 <div style="text-align:center;"><br><br></div>
		</div>
    </div> <!-- end #post -->


	<button id="js-fullscreen"><span id="icon-arrow" class="fontello"></span></button>
    <script src="/assets/js/jquery-2.0.3.min.js"></script>
    <script src="/assets/js/jquery.pjax.js"></script>
    <script src="/assets/js/nprogress.js"></script>
    <script src="/assets/js/script.js"></script>
	

   <script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fd0bee4b588a6732505f743a27e4cb5e3' type='text/javascript'%3E%3C/script%3E"));
	</script>

  </body>
</html>
